<!DOCTYPE html>
<html>
<head>
    <title>{{ thread.title }}</title>
</head>
<body>

<h1>{{ thread.title }}</h1>
<p>{{ thread.content }}</p>

<small>
    Posted by {{ thread.author }} on {{ thread.created_at }}
</small>
{% if user == thread.author or user.is_superuser %}
    <form method="post" action="{% url 'delete_thread' thread.id %}">
        {% csrf_token %}
        <button type="submit" style="color:red;">Delete Thread</button>
    </form>
{% endif %}

<!-- ğŸ” ADMIN LOCK / UNLOCK -->
{% if user.is_superuser %}
    <form method="post" action="{% url 'toggle_thread_lock' thread.id %}">
        {% csrf_token %}
        {% if thread.is_locked %}
            <button type="submit">Unlock Thread</button>
        {% else %}
            <button type="submit">Lock Thread</button>
        {% endif %}
    </form>
{% endif %}

<hr>

<h2>Replies</h2>

<ul>
{% for reply in replies %}
    {% if not reply.parent %}
        <li>
            <strong>{{ reply.author }}</strong>: {{ reply.content }} <br>
            <small>{{ reply.created_at }}</small>

            <form method="post" action="{% url 'report_reply' reply.id %}">
                {% csrf_token %}
                 <input type="text" name="reason" placeholder="Reason" required>
                <button type="submit">Report</button>
            </form>


            <!-- ğŸ‘ UPVOTE (PARENT REPLY) -->
            <form method="post" action="{% url 'toggle_reply_upvote' reply.id %}">
                {% csrf_token %}
                <button type="submit">
                    ğŸ‘ {{ reply.votes.count }}
                </button>
            </form>

            <!-- ğŸ—‘ DELETE (PARENT REPLY) -->
            {% if user == reply.author or user.is_superuser %}
                <form method="post" action="{% url 'delete_reply' reply.id %}">
                    {% csrf_token %}
                    <button type="submit">Delete</button>
                </form>

                <a href="{% url 'edit_reply' reply.id %}">Edit</a>
            {% endif %}


            <!-- ğŸ” CHILD (NESTED) REPLIES -->
            <ul>
            {% for child in reply.children.all %}
                <li>
                    <strong>{{ child.author }}</strong>: {{ child.content }} <br>
                    <small>{{ child.created_at }}</small>

                    <!-- ğŸ‘ UPVOTE (CHILD REPLY) -->
                    <form method="post" action="{% url 'toggle_reply_upvote' child.id %}">
                        {% csrf_token %}
                        <button type="submit">
                            ğŸ‘ {{ child.votes.count }}
                        </button>
                    </form>

                    <form method="post" action="{% url 'report_reply' child.id %}">
                        {% csrf_token %}
                        <input type="text" name="reason" placeholder="Reason" required>
                        <button type="submit">Report</button>
                    </form>


                    <!-- ğŸ—‘ DELETE (CHILD REPLY) -->
                    {% if user == child.author or user.is_superuser %}
                        <form method="post" action="{% url 'delete_reply' child.id %}">
                            {% csrf_token %}
                            <button type="submit">Delete</button>
                        </form>

                        <a href="{% url 'edit_reply' child.id %}">Edit</a>
                    {% endif %}

                </li>
            {% endfor %}
            </ul>

            <!-- â• REPLY TO THIS REPLY -->
            {% if not thread.is_locked %}
                <form method="post" action="{% url 'add_reply' thread.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ reply.id }}">
                    <textarea name="content" required></textarea>
                    <button type="submit">Reply</button>
                </form>
            {% endif %}

        </li>
        <hr>
    {% endif %}
{% endfor %}
</ul>

<hr>

<h3>Add Reply (Top-level)</h3>

{% if not thread.is_locked %}
    <form method="post" action="{% url 'add_reply' thread.id %}">
        {% csrf_token %}
        <textarea name="content" required></textarea>
        <button type="submit">Reply</button>
    </form>
{% else %}
    <p><strong>This thread is locked. No more replies allowed.</strong></p>
{% endif %}

<br>
<a href="{% url 'home' %}">Back to Home</a>

</body>
</html>
